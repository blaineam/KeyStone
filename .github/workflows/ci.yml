name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test-macos:
    name: Build & Test (macOS)
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'

    - name: Build Package
      run: swift build -v

    - name: Run Tests
      run: swift test -v

  build-ios:
    name: Build (iOS)
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'

    - name: Build for iOS Simulator
      run: |
        xcodebuild build \
          -scheme Keystone \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
          -skipPackagePluginValidation \
          | xcpretty --color

  lint:
    name: Swift Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check Swift formatting
      run: |
        # Check for common issues (basic lint without external tools)
        echo "Checking for trailing whitespace..."
        # Exclude binary files (images, etc.) using -I flag
        ! grep -rIn " $" Sources/ Tests/ --include="*.swift" --include="*.tutorial" --include="*.plist" || (echo "Found trailing whitespace" && false)
        echo "Checking for TODO/FIXME comments..."
        grep -rn "TODO\|FIXME" Sources/ Tests/ --include="*.swift" || echo "No TODO/FIXME found"
        echo "Lint check passed!"
